#include "common.h"
#include "note.h"
#include "stdlib.h"
#include "vdp.h"

#include "beatmap.h"

static uint8_t beatmap[BEATMAP_LEN];

void beatmap_init() {
	c_beat = c_frame = c_subframe = 0;
	// GOLD RUSH is 162 bpm, each beat is 22.2222 or 18.1582 frames
	//s_frames = vdp_get_palmode() ? 18 : 22;
	//s_subframes = vdp_get_palmode() ? 1582 : 2222;
	// but apparently a beat is 4 rows... so 5.5556 / 4.2696
	//s_frames = vdp_get_palmode() ? 4 : 5;
	//s_subframes = vdp_get_palmode() ? 2696 : 5556;
	// no that's too fast I guess BPM means jack shit
	s_frames = vdp_get_palmode() ? 6 : 8;
	s_subframes = vdp_get_palmode() ? 6667 : 0;
}

static void do_row(uint16_t index) {
	uint8_t row = beatmap[BEATMAP_LEN - index];
	for(uint8_t mask = NOTE_SCRATCH; mask; mask >>= 1) {
		if(row & mask) note_create(mask);
	}
}

void beatmap_update() {
	// Update timers
	c_frame++;
	c_subframe += s_subframes;
	if(c_subframe > 9999) {
		c_subframe -= 10000;
		c_frame++;
	}
	if(c_frame >= s_frames) {
		c_frame -= s_frames;
		c_beat++;
		do_row(c_beat);
	}
}

static uint8_t beatmap[BEATMAP_LEN] = {
	/* 64 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 63 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 62 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 61 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 60 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 59 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 58 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 57 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 56 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 55 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 54 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 53 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 52 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 51 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 50 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 49 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 48 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 47 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 46 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 45 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 44 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 43 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 42 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 41 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 40 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 39 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 38 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 37 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 36 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 35 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 34 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 33 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 32 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 31 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 30 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 29 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 28 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 27 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 26 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 25 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 24 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	/* 23 */
	0b00001000,
	0b00000000,
	0b00000001,
	0b01000100,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b01000000,
	
	0b00000010,
	0b00000000,
	0b00000100,
	0b01000001,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b01000001,
	/* 22 */
	0b00000000,
	0b00010000,
	0b00000000,
	0b00000100,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b01000000,
	
	0b00000010,
	0b00000000,
	0b00001000,
	0b01000010,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b01000000,
	/* 21 */
	0b00000010,
	0b00000000,
	0b00000100,
	0b01010000,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b01000000,
	
	0b00000010,
	0b00000000,
	0b00000100,
	0b01000001,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b11000001,
	/* 20 */
	0b00000000,
	0b00000100,
	0b00000000,
	0b00010000,
	
	0b00000000,
	0b01000000,
	0b00000001,
	0b00000000,
	
	0b00000001,
	0b00100000,
	0b00000010,
	0b00100000,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	/* 19 */
	0b00000010,
	0b00000000,
	0b00000100,
	0b00010000,
	
	0b00000000,
	0b00100001,
	0b00000000,
	0b00000000,
	
	0b00100001,
	0b00000000,
	0b00000010,
	0b01001000,
	
	0b00000000,
	0b01001000,
	0b00000000,
	0b01001000,
	/* 18 */
	0b00000000,
	0b00010000,
	0b00000000,
	0b00000100,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b00000000,
	
	0b00000010,
	0b00000000,
	0b00100000,
	0b00000010,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	/* 17 */
	0b00000010,
	0b00000000,
	0b00000100,
	0b00010000,
	
	0b00000000,
	0b00100001,
	0b00000000,
	0b00000000,
	
	0b00100001,
	0b00000000,
	0b00000010,
	0b01001000,
	
	0b00000000,
	0b01001000,
	0b00000000,
	0b01001000,
	/* 16 */
	0b00000000,
	0b00100000,
	0b00000000,
	0b00000010,
	
	0b00000000,
	0b00100000,
	0b00000010,
	0b00000000,
	
	0b00000010,
	0b00000000,
	0b00000100,
	0b00000000,
	
	0b00000000,
	0b00010000,
	0b00000000,
	0b00000000,
	/* 15 */
	0b00010000,
	0b00000000,
	0b00001000,
	0b01000000,
	
	0b00000000,
	0b00100001,
	0b00000000,
	0b00000000,
	
	0b00100001,
	0b00000000,
	0b00000010,
	0b01001000,
	
	0b00000000,
	0b01001000,
	0b00000000,
	0b01001000,
	/* 14 */
	0b00000000,
	0b00010000,
	0b00000000,
	0b00000100,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b00000000,
	
	0b00000010,
	0b00000000,
	0b00100000,
	0b00000010,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	/* 13 */
	0b00000010,
	0b00000000,
	0b00000100,
	0b00010000,
	
	0b00000000,
	0b00100001,
	0b00000000,
	0b00000000,
	
	0b00100001,
	0b00000000,
	0b00000010,
	0b01001000,
	
	0b00000000,
	0b01001000,
	0b00000000,
	0b01001000,
	/* 12 */
	0b00000000,
	0b00010000,
	0b00000000,
	0b00000100,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b00000000,
	
	0b00000010,
	0b00000000,
	0b00100000,
	0b00000010,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	/* 11 */
	0b00000010,
	0b00000000,
	0b00010000,
	0b01000000,
	
	0b00000000,
	0b00000100,
	0b00000000,
	0b00000000,
	
	0b00000100,
	0b00000000,
	0b01000000,
	0b00000100,
	
	0b00000000,
	0b00000100,
	0b00000000,
	0b00000100,
	/* 10 */
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b10000010,
	/* 09 - some notes seem off beat in this one */
	0b00000000,
	0b00010000,
	0b01000000,
	0b00000010,
	
	0b00000000,
	0b00010000,
	0b00000000,
	0b00000010,
	
	0b00000000,
	0b00010000,
	0b01000000,
	0b00000010,
	
	0b00000000,
	0b00010000,
	0b01000000,
	0b10000010,
	/* 08 */
	0b00000000,
	0b00100000,
	0b00000000,
	0b00000000,
	
	0b00100000,
	0b00000000,
	0b00000000,
	0b10000010,
	
	0b00000000,
	0b00100000,
	0b00000000,
	0b00000000,
	
	0b00100000,
	0b00000000,
	0b00000000,
	0b10000010,
	/* 07 */
	0b00000000,
	0b00001000,
	0b00000000,
	0b00100000,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b00000000,
	
	0b00010000,
	0b00000000,
	0b00000000,
	0b00000001,
	/* 06 */
	0b00000000,
	0b00000010,
	0b00000000,
	0b00100000,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b00000000,
	
	0b00010000,
	0b00000000,
	0b00000000,
	0b10000001,
	/* 05 */
	0b00000000,
	0b00000010,
	0b00000000,
	0b00100000,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b00000000,
	
	0b00010000,
	0b00000000,
	0b00000000,
	0b00000001,
	/* 04 */
	0b00000000,
	0b00000010,
	0b00000000,
	0b00100000,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b00000000,
	
	0b00010000,
	0b00000000,
	0b00000000,
	0b10000001,
	/* 03 */
	0b00000000,
	0b10000010,
	0b00000000,
	0b00100000,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b00000000,
	
	0b00010000,
	0b00000000,
	0b00000000,
	0b00000001,
	/* 02 */
	0b00000000,
	0b00000010,
	0b00000000,
	0b00100000,
	
	0b00000000,
	0b00000010,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000001,
	0b00000000,
	0b00000000,
	
	0b00010000,
	0b00000000,
	0b00000000,
	0b10000001,
	/* 01 */
	0b00000000,
	0b10000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
	
	0b00000000,
	0b00000000,
	0b00000000,
	0b00000000,
};
